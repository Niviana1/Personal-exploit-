local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Player = Players.LocalPlayer
local BuyKart = Workspace:WaitForChild("BarbStores").FarmKart.CustomerSeat
local Karts = Workspace.Karts
local RiceFolder = Workspace.Rice
local RemoteEvent = ReplicatedStorage.RemoteEvent

local function GetTool(Name)
    local Tool = Player:FindFirstChild(Name) or Player.Backpack:FindFirstChild(Name)
    if Tool and Player.Character then
        Tool.Parent = Player.Character
        return Tool
    end
end

local function GetRice()
    for _, Rice in ipairs(RiceFolder:GetChildren()) do
        local Model = Rice:FindFirstChildOfClass("Model")
        local Health = Rice:FindFirstChild("Health")
        local Reward = Rice:FindFirstChild("Reward")
        if Model and Model.PrimaryPart and Health and Reward and Health.Value > 0 and Reward.Value > 0 then
            return Rice, Model.PrimaryPart
        end
    end
end

local function UseKart(Kart)
    if Kart.Name == Player.Name then
        local Sickles = {Kart.LeftSickle, Kart.RightSickle}
        local Rice, Part = GetRice()
        while Kart.Parent == Karts and Rice do
            if Kart.VehicleSeat and Kart.VehicleSeat.Occupant ~= Player.Character.Humanoid then
                Kart.VehicleSeat:Sit(Player.Character.Humanoid)
            end
            if Kart.PrimaryPart then
                Kart:SetPrimaryPartCFrame(Part.CFrame * CFrame.new(0, 5, -3))
                for _, Sickle in ipairs(Sickles) do
                    Sickle.Touched:Fire(Part)
                end
            end
            wait()
            Rice, Part = GetRice()
        end
    end
end

while true do
    if not Karts:FindFirstChild(Player.Name) then
        local Tool = GetTool("FarmKart")
        if Player.Character and Player.Character:FindFirstChild("Humanoid") and Player.Character.Humanoid.Health <= 0 then
            RemoteEvent:FireServer("Respawn")
        elseif Tool then
            Tool:Activate()
        else
            BuyKart:Sit(Player.Character.Humanoid)
        end
    else
        UseKart(Karts[Player.Name])
    end
    wait(2.3)
end
